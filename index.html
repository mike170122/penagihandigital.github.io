<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penagihan Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                left: 0;
                z-index: 40;
                height: 100%;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-right: 0 !important;
                width: 100% !important;
            }
            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            .mobile-overlay.show {
                display: block;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .mobile-menu-btn {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
            .main-content {
                margin-right: 0;
            }
        }
        
        /* Full screen mobile viewport */
        @media screen and (max-width: 768px) {
            html, body {
                height: 100%;
                overflow-x: hidden;
            }
            .dashboard-container {
                height: 100vh;
                overflow: hidden;
            }
            .main-content-area {
                height: calc(100vh - 60px);
                overflow-y: auto;
            }
        }
        
        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .dashboard-container {
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-200 to-blue-300 font-sans">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-file-invoice-dollar text-4xl text-indigo-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Sistem Penagihan Digital</h2>
                <p class="mt-2 text-gray-600">Masuk ke akun Anda</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input id="loginUsername" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="admin">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input id="loginPassword" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="••••••••">
                </div>
                <div class="flex items-center">
                    <input id="rememberMe" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="rememberMe" class="ml-2 block text-sm text-gray-700">
                        Ingat saya
                    </label>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 font-medium">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
                <p class="text-center text-sm text-gray-600">
                    Belum punya akun? 
                    <button type="button" onclick="showRegister()" class="text-indigo-600 hover:text-indigo-500 font-medium">Daftar di sini</button>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 hidden">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-user-plus text-4xl text-green-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Daftar Akun Baru</h2>
                <p class="mt-2 text-gray-600">Buat akun untuk mengakses sistem</p>
            </div>
            <form id="registerForm" class="mt-8 space-y-6">
                <div>
                    <label for="registerName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input id="registerName" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Nama Lengkap">
                </div>
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input id="registerEmail" type="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="email@example.com">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input id="registerPassword" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                    <i class="fas fa-user-plus mr-2"></i>Daftar
                </button>
                <p class="text-center text-sm text-gray-600">
                    Sudah punya akun? 
                    <button type="button" onclick="showLogin()" class="text-green-600 hover:text-green-500 font-medium">Masuk di sini</button>
                </p>
            </form>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden dashboard-container flex">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar w-64 bg-gray-900 text-white flex-shrink-0 flex flex-col">
            <div class="flex-1 p-6">
                <div class="mb-8">
                    <p class="text-sm text-gray-400 mb-2" id="sidebarWelcome">Selamat datang, Admin</p>
                    <div class="flex items-center">
                        <i class="fas fa-file-invoice-dollar text-2xl text-indigo-400 mr-3"></i>
                        <h1 class="text-xl font-bold">Rekap Penagihan</h1>
                    </div>
                </div>
                
                <nav class="space-y-2">
                    <a href="#" onclick="showDashboard()" class="flex items-center px-4 py-3 rounded-lg bg-indigo-600 text-white" id="menuDashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" onclick="showBills()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200" id="menuBills">
                        <i class="fas fa-file-invoice mr-3"></i>
                        Data Tagihan
                    </a>
                    <a href="#" onclick="showExportImport()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200" id="menuExportImport">
                        <i class="fas fa-exchange-alt mr-3"></i>
                        Export/Import
                    </a>
                    <a href="#" onclick="showReports()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200" id="menuReports">
                        <i class="fas fa-chart-bar mr-3"></i>
                        Laporan
                    </a>
                    <a href="#" onclick="showUserManagement()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200" id="menuUserManagement">
                        <i class="fas fa-users mr-3"></i>
                        Kelola User
                    </a>
                    <a href="#" onclick="showSettings()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition duration-200" id="menuSettings">
                        <i class="fas fa-cog mr-3"></i>
                        Pengaturan
                    </a>
                    <button onclick="logout()" class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-red-600 hover:text-white transition duration-200 w-full text-left mt-2">
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        Keluar
                    </button>
                </nav>
            </div>
            
            <!-- User info at bottom -->
            <div class="p-6 border-t border-gray-700 mt-auto">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="font-medium" id="sidebarUserName">Admin</p>
                        <p class="text-sm text-gray-400">Administrator</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content flex-1 flex flex-col">
            <!-- Top Navigation -->
            <nav class="bg-white shadow-sm border-b border-gray-200">
                <div class="px-4 md:px-6 py-3 md:py-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <button id="mobileMenuBtn" class="mobile-menu-btn mr-3 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                                <i class="fas fa-bars text-gray-600"></i>
                            </button>
                            <h2 id="pageTitle" class="text-xl md:text-2xl font-bold text-gray-900">Dashboard</h2>
                        </div>
                        <div class="flex items-center space-x-2 md:space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-sm text-green-600 font-medium">Online</span>
                                <span class="text-sm text-gray-600 font-mono" id="currentTimeDisplay">00:00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <main class="main-content-area flex-1 p-4 md:p-6 bg-gray-50 overflow-y-auto">
                <!-- Dashboard Content -->
                <div id="dashboardContent">
                    <!-- Stats Cards -->
                    <div class="stats-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Total Tagihan</p>
                                    <p class="text-3xl font-bold text-gray-900" id="totalBills">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Lunas</p>
                                    <p class="text-3xl font-bold text-gray-900" id="paidBills">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Belum Lunas</p>
                                    <p class="text-3xl font-bold text-gray-900" id="pendingBills">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-indigo-100 rounded-lg">
                                    <i class="fas fa-dollar-sign text-indigo-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Total Nilai</p>
                                    <p class="text-3xl font-bold text-gray-900" id="totalAmount">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Access to Reports (Admin Only) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8" id="dashboardReportsSection">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-chart-bar text-indigo-500 mr-3"></i>
                            Akses Cepat Laporan
                        </h3>
                        <div class="flex justify-center">
                            <button onclick="showReports()" class="flex flex-col items-center p-6 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors duration-200 group">
                                <div class="w-16 h-16 bg-indigo-500 rounded-lg flex items-center justify-center mb-4 group-hover:bg-indigo-600 transition-colors duration-200">
                                    <i class="fas fa-chart-bar text-white text-2xl"></i>
                                </div>
                                <span class="text-lg font-medium text-gray-700 text-center">Lihat Laporan Lengkap</span>
                                <span class="text-sm text-gray-500 text-center mt-1">Analisis data dan statistik</span>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-history text-blue-500 mr-3"></i>
                            Aktivitas Terbaru
                        </h3>
                        <div id="recentActivity" class="space-y-4">
                            <!-- Recent activity will be populated here -->
                        </div>
                        <div class="mt-6 text-center">
                            <button onclick="showBills()" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                                Lihat Semua Data →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bills Content -->
                <div id="billsContent" class="hidden">
                    <!-- Action Buttons -->
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6 md:mb-8">
                        <div class="flex flex-wrap gap-3 md:gap-4">
                            <button onclick="showAddForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200 text-sm md:text-base">
                                <i class="fas fa-plus mr-2"></i>Tambah Tagihan
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-4 md:px-6 py-3 md:py-4 border-b border-gray-200">
                            <h3 class="text-base md:text-lg font-semibold text-gray-900">Data Penagihan</h3>
                        </div>
                        <div class="table-container overflow-x-auto">
                            <table class="w-full min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Petugas</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelanggan</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="createdByHeader">Dibuat Oleh</th>
                                        <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="billsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Export/Import Content -->
                <div id="exportImportContent" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <!-- Export Section -->
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-3 md:mb-4 flex items-center">
                                <i class="fas fa-download text-blue-600 mr-2"></i>
                                Export Data
                            </h3>
                            <p class="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Ekspor data tagihan dalam berbagai format</p>
                            
                            <div class="space-y-3">
                                <button onclick="exportPDF()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                                </button>
                                <button onclick="exportExcel()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                                </button>
                                <button onclick="exportJSON()" class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-file-code mr-2"></i>Export JSON
                                </button>
                            </div>
                        </div>

                        <!-- WhatsApp Share Section -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                                Kirim via WhatsApp
                            </h3>
                            <p class="text-gray-600 mb-6">Bagikan data tagihan melalui WhatsApp</p>
                            
                            <button onclick="shareViaWhatsApp()" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition duration-200 flex items-center justify-center">
                                <i class="fab fa-whatsapp mr-2"></i>Kirim Data via WhatsApp
                            </button>
                            
                            <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                                <h4 class="text-sm font-semibold text-green-800 mb-2">Fitur WhatsApp:</h4>
                                <ul class="text-xs text-green-700 space-y-1">
                                    <li>• Otomatis kirim file (HP modern)</li>
                                    <li>• Download manual + pesan</li>
                                    <li>• Hanya kirim ringkasan</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Import Section (Admin Only) -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200" id="importSection">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-upload text-indigo-600 mr-2"></i>
                                Import Data
                            </h3>
                            <p class="text-gray-600 mb-6">Import data tagihan dari file JSON</p>
                            
                            <label class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-200 cursor-pointer flex items-center justify-center">
                                <i class="fas fa-upload mr-2"></i>Pilih File JSON
                                <input type="file" id="jsonImport" accept=".json" class="hidden" onchange="importJSON(event)">
                            </label>
                            
                            <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="text-sm font-semibold text-blue-800 mb-2">Format yang Didukung:</h4>
                                <ul class="text-xs text-blue-700 space-y-1">
                                    <li>• File JSON dari sistem ini</li>
                                    <li>• Format dengan metadata lengkap</li>
                                    <li>• Data akan ditambahkan ke existing</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                                Statistik Export/Import
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Total Data:</span>
                                    <span class="font-semibold" id="exportStatsTotal">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Data Lunas:</span>
                                    <span class="font-semibold text-green-600" id="exportStatsPaid">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Belum Lunas:</span>
                                    <span class="font-semibold text-yellow-600" id="exportStatsPending">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Total Nilai:</span>
                                    <span class="font-semibold text-indigo-600" id="exportStatsAmount">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Management (Admin Only) -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200" id="dataManagementSection">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-database text-red-600 mr-2"></i>
                                Kelola Data
                            </h3>
                            <p class="text-gray-600 mb-4">Kelola data yang tersimpan di browser</p>
                            
                            <div class="space-y-3">
                                <button onclick="clearAllData()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-trash-alt mr-2"></i>Hapus Semua Data
                                </button>
                                <button onclick="resetToDemo()" class="w-full bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700 transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-undo mr-2"></i>Reset ke Data Demo
                                </button>
                            </div>
                            
                            <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                                <h4 class="text-sm font-semibold text-red-800 mb-2">⚠️ Peringatan:</h4>
                                <ul class="text-xs text-red-700 space-y-1">
                                    <li>• Hapus semua data akan menghapus seluruh tagihan</li>
                                    <li>• Reset akan mengembalikan ke data contoh</li>
                                    <li>• Aksi ini tidak dapat dibatalkan</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Content -->
                <div id="userManagementContent" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Add User Section -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-user-plus text-green-600 mr-2"></i>
                                Tambah User Baru
                            </h3>
                            
                            <form id="addUserForm" class="space-y-4">
                                <div>
                                    <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                    <input type="text" id="newUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="newUserName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="newUserName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <input type="password" id="newUserPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select id="newUserRole" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                                    <i class="fas fa-user-plus mr-2"></i>Tambah User
                                </button>
                            </form>
                        </div>

                        <!-- User List Section -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-users text-blue-600 mr-2"></i>
                                Daftar User
                            </h3>
                            
                            <div class="space-y-3" id="userList">
                                <!-- User list will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Content -->
                <div id="reportsContent" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i class="fas fa-money-bill-wave text-green-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Total Pemasukan</p>
                                    <p class="text-2xl font-bold text-green-600" id="reportTotalIncome">Rp 0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i class="fas fa-hourglass-half text-yellow-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Belum Terbayar</p>
                                    <p class="text-2xl font-bold text-yellow-600" id="reportPendingAmount">Rp 0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i class="fas fa-percentage text-blue-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Tingkat Pembayaran</p>
                                    <p class="text-2xl font-bold text-blue-600" id="reportPaymentRate">0%</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <i class="fas fa-chart-line text-purple-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium">Rata-rata Tagihan</p>
                                    <p class="text-2xl font-bold text-purple-600" id="reportAvgBill">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Laporan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="reportStartDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="reportEndDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="reportPetugas" class="block text-sm font-medium text-gray-700 mb-2">Petugas</label>
                                <select id="reportPetugas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Semua Petugas</option>
                                    <option value="Mario">Mario</option>
                                    <option value="Macho">Macho</option>
                                    <option value="Stevi">Stevi</option>
                                    <option value="Rian">Rian</option>
                                    <option value="Ibed">Ibed</option>
                                    <option value="Stevian">Stevian</option>
                                    <option value="Glen Ohman">Glen Ohman</option>
                                    <option value="Glen">Glen</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="generateReport()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                                    <i class="fas fa-chart-bar mr-2"></i>Generate Laporan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Report Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Performance by Officer -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-user-tie text-blue-600 mr-2"></i>
                                Kinerja Per Petugas
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Petugas</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lunas</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="officerPerformanceTable" class="divide-y divide-gray-200">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Payment Method Analysis -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-credit-card text-green-600 mr-2"></i>
                                Analisis Metode Pembayaran
                            </h3>
                            <div class="space-y-4" id="paymentMethodAnalysis">
                                <!-- Data will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Trend -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            Tren Bulanan
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Bulan</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Tagihan</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lunas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Belum Lunas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Nilai</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tingkat Pembayaran</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTrendTable" class="divide-y divide-gray-200">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Data Entry Activity -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-users text-indigo-600 mr-2"></i>
                            Aktivitas Input Data
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data Dibuat</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data Diedit</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Aktivitas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Terakhir Aktif</th>
                                    </tr>
                                </thead>
                                <tbody id="userActivityTable" class="divide-y divide-gray-200">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Content -->
                <div id="settingsContent" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Sistem</h3>
                        <p class="text-gray-600">Fitur pengaturan akan segera tersedia.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Form Modal -->
    <div id="formModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl max-w-md w-full my-8 max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="formTitle" class="text-xl font-bold text-gray-900">Tambah Tagihan</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="billForm">
                <div class="space-y-4">
                    <div>
                        <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 mb-2">Nama Petugas</label>
                        <select id="invoiceNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="">Pilih Petugas</option>
                            <option value="Mario">Mario</option>
                            <option value="Macho">Macho</option>
                            <option value="Stevi">Stevi</option>
                            <option value="Rian">Rian</option>
                            <option value="Ibed">Ibed</option>
                            <option value="Stevian">Stevian</option>
                            <option value="Glen Ohman">Glen Ohman</option>
                            <option value="Glen">Glen</option>
                        </select>
                    </div>
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">Nama Pelanggan</label>
                        <input type="text" id="customerName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="billDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Tagihan</label>
                        <input type="date" id="billDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                        <input type="number" id="amount" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                        <select id="paymentMethod" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="tunai">Tunai</option>
                            <option value="transfer">Transfer</option>
                        </select>
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="status" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="pending">Belum Lunas</option>
                            <option value="paid">Lunas</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Offline Notice -->
    <div id="offlineNotice" class="fixed inset-0 bg-gray-900 text-white flex items-center justify-center z-50 hidden">
        <div class="text-center p-8">
            <i class="fas fa-clock text-6xl text-yellow-400 mb-6"></i>
            <h2 class="text-3xl font-bold mb-4">Sistem Sedang Offline</h2>
            <p class="text-xl mb-4">Sistem Rekap Penagihan beroperasi pada:</p>
            <div class="bg-gray-800 p-4 rounded-lg mb-6">
                <p class="text-2xl font-bold text-green-400">08:00 - 23:00 WIB</p>
            </div>
            <p class="text-gray-300 mb-4">Waktu saat ini: <span id="currentTime" class="font-bold text-yellow-400"></span></p>
            <p class="text-gray-400">Silakan kembali pada jam operasional</p>
            <div class="mt-6">
                <div class="inline-block bg-yellow-600 px-4 py-2 rounded-lg">
                    <i class="fas fa-hourglass-half mr-2"></i>
                    <span id="nextOnlineTime">Sistem akan online kembali pada 08:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // System time configuration
        const ONLINE_START_HOUR = 8;  // 8 AM
        const ONLINE_END_HOUR = 23;   // 11 PM
        
        // Initialize bills from localStorage or empty array
        let bills = loadBillsFromStorage();

        // User accounts with roles - load from localStorage or use defaults
        let userAccounts = loadUserAccountsFromStorage();

        // Data persistence functions
        function loadBillsFromStorage() {
            try {
                const savedBills = localStorage.getItem('billsData');
                if (savedBills) {
                    const parsedBills = JSON.parse(savedBills);
                    console.log('Loaded bills from storage:', parsedBills.length, 'records');
                    return parsedBills;
                }
            } catch (error) {
                console.error('Error loading bills from storage:', error);
            }
            
            // Return empty array if no saved data or error
            console.log('No saved bills found, starting with empty data');
            return [];
        }

        function saveBillsToStorage() {
            try {
                localStorage.setItem('billsData', JSON.stringify(bills));
                console.log('Bills saved to storage:', bills.length, 'records');
            } catch (error) {
                console.error('Error saving bills to storage:', error);
                showToast('Gagal menyimpan data ke penyimpanan lokal', 'error');
            }
        }

        function loadUserAccountsFromStorage() {
            try {
                const savedAccounts = localStorage.getItem('userAccounts');
                if (savedAccounts) {
                    return JSON.parse(savedAccounts);
                }
            } catch (error) {
                console.error('Error loading user accounts from storage:', error);
            }
            
            // Return default accounts if no saved data
            return {
                'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
                'user1': { password: 'user123', role: 'user', name: 'User Biasa' },
                'mario': { password: 'mario123', role: 'user', name: 'Mario' },
                'macho': { password: 'macho123', role: 'user', name: 'Macho' }
            };
        }

        function saveUserAccountsToStorage() {
            try {
                localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
                console.log('User accounts saved to storage');
            } catch (error) {
                console.error('Error saving user accounts to storage:', error);
            }
        }

        let currentUser = null;
        let editingId = null;
        let timeCheckInterval = null;

        // Time management functions
        function isSystemOnline() {
            const now = new Date();
            const currentHour = now.getHours();
            return currentHour >= ONLINE_START_HOUR && currentHour < ONLINE_END_HOUR;
        }

        function updateCurrentTime() {
            const now = new Date();
            
            // Format untuk header (lengkap dengan hari/tanggal/jam/menit/detik WIT)
            const headerTimeString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: 'Asia/Jayapura'
            }) + ' ' + now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jayapura'
            }) + ' WIT';
            
            // Format untuk offline notice (lebih detail)
            const offlineTimeString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'Asia/Jayapura'
            }) + ', ' + now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jayapura'
            }) + ' WIT';
            
            // Update offline notice time
            const currentTimeElement = document.getElementById('currentTime');
            if (currentTimeElement) {
                currentTimeElement.textContent = offlineTimeString;
            }
            
            // Update header time display
            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            if (currentTimeDisplay) {
                currentTimeDisplay.textContent = headerTimeString;
            }
        }

        function updateNextOnlineTime() {
            const now = new Date();
            const currentHour = now.getHours();
            let nextOnlineText = '';
            
            if (currentHour < ONLINE_START_HOUR) {
                nextOnlineText = `Sistem akan online pada ${ONLINE_START_HOUR.toString().padStart(2, '0')}:00 hari ini`;
            } else {
                nextOnlineText = `Sistem akan online pada ${ONLINE_START_HOUR.toString().padStart(2, '0')}:00 besok`;
            }
            
            const nextOnlineElement = document.getElementById('nextOnlineTime');
            if (nextOnlineElement) {
                nextOnlineElement.textContent = nextOnlineText;
            }
        }

        function checkSystemStatus() {
            const isOnline = isSystemOnline();
            const offlineNotice = document.getElementById('offlineNotice');
            const loginPage = document.getElementById('loginPage');
            const registerPage = document.getElementById('registerPage');
            const dashboard = document.getElementById('dashboard');
            
            if (!isOnline) {
                // System is offline
                offlineNotice.classList.remove('hidden');
                loginPage.classList.add('hidden');
                registerPage.classList.add('hidden');
                dashboard.classList.add('hidden');
                
                // If user was logged in, log them out
                if (currentUser) {
                    currentUser = null;
                    showToast('Sistem telah offline. Anda telah keluar otomatis.', 'info');
                }
                
                updateCurrentTime();
                updateNextOnlineTime();
            } else {
                // System is online
                offlineNotice.classList.add('hidden');
                
                // Show appropriate page based on login status
                if (currentUser) {
                    dashboard.classList.remove('hidden');
                } else {
                    loginPage.classList.remove('hidden');
                }
            }
        }

        function startTimeMonitoring() {
            // Check immediately
            checkSystemStatus();
            
            // Check every 30 seconds
            timeCheckInterval = setInterval(() => {
                checkSystemStatus();
            }, 30000);
            
            // Update time display every second
            setInterval(() => {
                updateCurrentTime();
            }, 1000);
        }

        // Authentication functions
        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            loadRememberedCredentials();
        }

        // Remember Me functionality
        function saveCredentials(username, password, remember) {
            if (remember) {
                localStorage.setItem('rememberedUsername', username);
                localStorage.setItem('rememberedPassword', password);
                localStorage.setItem('rememberMe', 'true');
            } else {
                localStorage.removeItem('rememberedUsername');
                localStorage.removeItem('rememberedPassword');
                localStorage.removeItem('rememberMe');
            }
        }

        function loadRememberedCredentials() {
            const remembered = localStorage.getItem('rememberMe') === 'true';
            if (remembered) {
                const username = localStorage.getItem('rememberedUsername');
                const password = localStorage.getItem('rememberedPassword');
                
                if (username && password) {
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                    document.getElementById('rememberMe').checked = true;
                }
            }
        }

        function showRegister() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.remove('hidden');
        }

        function login(event) {
            event.preventDefault();
            
            // Check if system is online before allowing login
            if (!isSystemOnline()) {
                showToast('Sistem sedang offline. Silakan coba lagi pada jam operasional (08:00 - 23:00 WIB)', 'error');
                return;
            }
            
            const username = document.getElementById('loginUsername').value.toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Validate credentials
            if (userAccounts[username] && userAccounts[username].password === password) {
                // Save or clear credentials based on remember me checkbox
                saveCredentials(username, password, rememberMe);
                
                currentUser = {
                    username: username,
                    name: userAccounts[username].name,
                    role: userAccounts[username].role
                };
                
                document.getElementById('sidebarWelcome').textContent = `Selamat datang, ${currentUser.name}`;
                document.getElementById('sidebarUserName').textContent = currentUser.name;
                
                // Update role display in sidebar
                const roleText = currentUser.role === 'admin' ? 'Administrator' : 'User';
                document.querySelector('.text-gray-400').textContent = roleText;
                
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('fade-in');
                
                // Apply role-based restrictions
                applyRoleRestrictions();
                
                showDashboard();
                updateStats();
                renderTable();
                showToast(`Login berhasil sebagai ${roleText}!`, 'success');
            } else {
                showToast('Username atau password salah!', 'error');
            }
        }

        // Role-based access control
        function applyRoleRestrictions() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // Hide/show menu items based on role
            const reportsMenu = document.getElementById('menuReports');
            const userManagementMenu = document.getElementById('menuUserManagement');
            const settingsMenu = document.getElementById('menuSettings');
            const dashboardReportsSection = document.getElementById('dashboardReportsSection');
            
            if (!isAdmin) {
                // Hide admin-only menus for users
                reportsMenu.style.display = 'none';
                userManagementMenu.style.display = 'none';
                settingsMenu.style.display = 'none';
                if (dashboardReportsSection) dashboardReportsSection.style.display = 'none';
            } else {
                // Show all menus for admin
                reportsMenu.style.display = 'flex';
                userManagementMenu.style.display = 'flex';
                settingsMenu.style.display = 'flex';
                if (dashboardReportsSection) dashboardReportsSection.style.display = 'block';
            }
        }

        // Recent Activity Functions
        function updateRecentActivity() {
            const recentActivityContainer = document.getElementById('recentActivity');
            
            // Get last 5 bills sorted by date
            const recentBills = bills
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentBills.length === 0) {
                recentActivityContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-500">Belum ada aktivitas terbaru</p>
                        <button onclick="showAddForm()" class="mt-3 text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                            Tambah Tagihan Pertama →
                        </button>
                    </div>
                `;
                return;
            }
            
            recentActivityContainer.innerHTML = recentBills.map(bill => {
                const timeAgo = getTimeAgo(bill.date);
                const statusColor = bill.status === 'paid' ? 'text-green-600' : 'text-yellow-600';
                const statusIcon = bill.status === 'paid' ? 'fa-check-circle' : 'fa-clock';
                const statusText = bill.status === 'paid' ? 'Lunas' : 'Belum Lunas';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                                <i class="fas ${statusIcon} ${statusColor}"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">${bill.customerName}</p>
                                <p class="text-sm text-gray-600">Petugas: ${bill.invoiceNumber} • ${formatCurrency(bill.amount)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs ${statusColor} font-medium">${statusText}</span>
                            <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMs = now - date;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInDays === 0) {
                return 'Hari ini';
            } else if (diffInDays === 1) {
                return 'Kemarin';
            } else if (diffInDays < 7) {
                return `${diffInDays} hari lalu`;
            } else if (diffInDays < 30) {
                const weeks = Math.floor(diffInDays / 7);
                return `${weeks} minggu lalu`;
            } else {
                const months = Math.floor(diffInDays / 30);
                return `${months} bulan lalu`;
            }
        }

        function applyExportImportRestrictions() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            const importSection = document.getElementById('importSection');
            const dataManagementSection = document.getElementById('dataManagementSection');
            
            if (!isAdmin) {
                // Hide admin-only sections for users
                importSection.style.display = 'none';
                dataManagementSection.style.display = 'none';
            } else {
                // Show admin sections for admin
                importSection.style.display = 'block';
                dataManagementSection.style.display = 'block';
            }
        }

        // Data management functions
        function clearAllData() {
            if (!checkPermission('delete')) {
                showToast('Anda tidak memiliki izin untuk menghapus data', 'error');
                return;
            }
            
            showCustomConfirm(
                'Hapus SEMUA data tagihan? Aksi ini tidak dapat dibatalkan!',
                () => {
                    bills = [];
                    saveBillsToStorage();
                    
                    updateStats();
                    renderTable();
                    updateRecentActivity();
                    updateExportStats();
                    
                    showToast('Semua data berhasil dihapus', 'success');
                }
            );
        }

        function resetToDemo() {
            if (!checkPermission('delete')) {
                showToast('Anda tidak memiliki izin untuk reset data', 'error');
                return;
            }
            
            showCustomConfirm(
                'Reset ke data demo? Data saat ini akan dihapus dan diganti dengan contoh data.',
                () => {
                    bills = [
                        {
                            id: 1,
                            invoiceNumber: 'Mario',
                            customerName: 'PT. Maju Jaya',
                            date: '2024-01-15',
                            amount: 5000000,
                            status: 'paid',
                            paymentMethod: 'transfer',
                            createdBy: 'admin',
                            createdAt: '2024-01-15T10:30:00.000Z',
                            updatedBy: 'admin',
                            updatedAt: '2024-01-15T10:30:00.000Z'
                        },
                        {
                            id: 2,
                            invoiceNumber: 'Macho',
                            customerName: 'CV. Berkah Sejahtera',
                            date: '2024-01-20',
                            amount: 3500000,
                            status: 'pending',
                            paymentMethod: 'tunai',
                            createdBy: 'mario',
                            createdAt: '2024-01-20T14:15:00.000Z',
                            updatedBy: 'mario',
                            updatedAt: '2024-01-20T14:15:00.000Z'
                        }
                    ];
                    
                    saveBillsToStorage();
                    
                    updateStats();
                    renderTable();
                    updateRecentActivity();
                    updateExportStats();
                    
                    showToast('Data berhasil direset ke contoh demo', 'success');
                }
            );
        }

        function updateExportStats() {
            const totalBills = bills.length;
            const paidBills = bills.filter(bill => bill.status === 'paid').length;
            const pendingBills = bills.filter(bill => bill.status === 'pending').length;
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);

            document.getElementById('exportStatsTotal').textContent = totalBills;
            document.getElementById('exportStatsPaid').textContent = paidBills;
            document.getElementById('exportStatsPending').textContent = pendingBills;
            document.getElementById('exportStatsAmount').textContent = formatCurrency(totalAmount);
        }

        // User Management Functions
        function renderUserList() {
            const userListContainer = document.getElementById('userList');
            userListContainer.innerHTML = '';

            Object.keys(userAccounts).forEach(username => {
                const user = userAccounts[username];
                const userCard = document.createElement('div');
                userCard.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                
                userCard.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-indigo-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${user.name}</p>
                            <p class="text-sm text-gray-500">@${username} • ${user.role === 'admin' ? 'Administrator' : 'User'}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.role === 'admin' ? 'Admin' : 'User'}
                        </span>
                        ${username !== 'admin' ? `<button onclick="deleteUser('${username}')" class="text-red-600 hover:text-red-800 p-1" title="Hapus User">
                            <i class="fas fa-trash text-sm"></i>
                        </button>` : ''}
                    </div>
                `;
                
                userListContainer.appendChild(userCard);
            });
        }

        function addUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value.toLowerCase();
            const name = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            // Check if username already exists
            if (userAccounts[username]) {
                showToast('Username sudah ada!', 'error');
                return;
            }

            // Add new user
            userAccounts[username] = {
                password: password,
                role: role,
                name: name
            };

            // Save to localStorage
            saveUserAccountsToStorage();

            // Clear form
            document.getElementById('addUserForm').reset();
            
            // Refresh user list
            renderUserList();
            
            showToast(`User ${name} berhasil ditambahkan!`, 'success');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                showToast('Admin utama tidak dapat dihapus!', 'error');
                return;
            }

            const user = userAccounts[username];
            showCustomConfirm(
                `Hapus user ${user.name} (@${username})?`,
                () => {
                    delete userAccounts[username];
                    
                    // Save to localStorage
                    saveUserAccountsToStorage();
                    
                    renderUserList();
                    showToast(`User ${user.name} berhasil dihapus`, 'success');
                }
            );
        }

        function checkPermission(action) {
            const isAdmin = currentUser && currentUser.role === 'admin';
            const isUser = currentUser && currentUser.role === 'user';
            
            switch(action) {
                case 'delete':
                case 'export':
                case 'import':
                case 'reports':
                case 'settings':
                case 'user_management':
                    return isAdmin; // Only admin can do these
                case 'add':
                case 'edit':
                case 'view':
                    return isAdmin || isUser; // Both admin and user can do these
                default:
                    return false;
            }
        }

        // Navigation functions
        function setActiveMenu(activeId) {
            // Remove active class from all menu items
            const menuItems = ['menuDashboard', 'menuBills', 'menuExportImport', 'menuReports', 'menuUserManagement', 'menuSettings'];
            menuItems.forEach(id => {
                const element = document.getElementById(id);
                element.classList.remove('bg-indigo-600', 'text-white');
                element.classList.add('text-gray-300');
            });

            // Add active class to selected menu
            const activeElement = document.getElementById(activeId);
            activeElement.classList.remove('text-gray-300');
            activeElement.classList.add('bg-indigo-600', 'text-white');
        }

        function hideAllContent() {
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('billsContent').classList.add('hidden');
            document.getElementById('exportImportContent').classList.add('hidden');
            document.getElementById('reportsContent').classList.add('hidden');
            document.getElementById('userManagementContent').classList.add('hidden');
            document.getElementById('settingsContent').classList.add('hidden');
        }

        function showDashboard() {
            hideAllContent();
            setActiveMenu('menuDashboard');
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('dashboardContent').classList.remove('hidden');
            updateStats();
            updateRecentActivity();
        }

        function showBills() {
            hideAllContent();
            setActiveMenu('menuBills');
            document.getElementById('pageTitle').textContent = 'Data Tagihan';
            document.getElementById('billsContent').classList.remove('hidden');
            renderTable();
        }

        function showExportImport() {
            hideAllContent();
            setActiveMenu('menuExportImport');
            document.getElementById('pageTitle').textContent = 'Export/Import Data';
            document.getElementById('exportImportContent').classList.remove('hidden');
            updateExportStats();
            applyExportImportRestrictions();
        }

        function showReports() {
            hideAllContent();
            setActiveMenu('menuReports');
            document.getElementById('pageTitle').textContent = 'Laporan';
            document.getElementById('reportsContent').classList.remove('hidden');
            
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
            
            // Generate initial report
            generateReport();
        }

        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const selectedPetugas = document.getElementById('reportPetugas').value;
            
            // Filter bills based on criteria
            let filteredBills = bills;
            
            if (startDate) {
                filteredBills = filteredBills.filter(bill => bill.date >= startDate);
            }
            if (endDate) {
                filteredBills = filteredBills.filter(bill => bill.date <= endDate);
            }
            if (selectedPetugas) {
                filteredBills = filteredBills.filter(bill => bill.invoiceNumber === selectedPetugas);
            }
            
            // Update summary cards
            updateReportSummary(filteredBills);
            
            // Update tables
            updateOfficerPerformance(filteredBills);
            updatePaymentMethodAnalysis(filteredBills);
            updateMonthlyTrend(filteredBills);
            updateUserActivity();
        }

        function updateReportSummary(filteredBills) {
            const totalIncome = filteredBills.filter(bill => bill.status === 'paid').reduce((sum, bill) => sum + bill.amount, 0);
            const pendingAmount = filteredBills.filter(bill => bill.status === 'pending').reduce((sum, bill) => sum + bill.amount, 0);
            const paidCount = filteredBills.filter(bill => bill.status === 'paid').length;
            const totalCount = filteredBills.length;
            const paymentRate = totalCount > 0 ? Math.round((paidCount / totalCount) * 100) : 0;
            const avgBill = totalCount > 0 ? Math.round(filteredBills.reduce((sum, bill) => sum + bill.amount, 0) / totalCount) : 0;
            
            document.getElementById('reportTotalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('reportPendingAmount').textContent = formatCurrency(pendingAmount);
            document.getElementById('reportPaymentRate').textContent = paymentRate + '%';
            document.getElementById('reportAvgBill').textContent = formatCurrency(avgBill);
        }

        function updateOfficerPerformance(filteredBills) {
            const tbody = document.getElementById('officerPerformanceTable');
            tbody.innerHTML = '';
            
            // Group by officer
            const officerStats = {};
            filteredBills.forEach(bill => {
                if (!officerStats[bill.invoiceNumber]) {
                    officerStats[bill.invoiceNumber] = {
                        total: 0,
                        paid: 0,
                        amount: 0
                    };
                }
                officerStats[bill.invoiceNumber].total++;
                if (bill.status === 'paid') {
                    officerStats[bill.invoiceNumber].paid++;
                }
                officerStats[bill.invoiceNumber].amount += bill.amount;
            });
            
            // Sort by total amount descending
            const sortedOfficers = Object.entries(officerStats).sort((a, b) => b[1].amount - a[1].amount);
            
            sortedOfficers.forEach(([officer, stats]) => {
                const paymentRate = stats.total > 0 ? Math.round((stats.paid / stats.total) * 100) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 text-sm font-medium text-gray-900">${officer}</td>
                    <td class="px-3 py-2 text-sm text-gray-600">${stats.total}</td>
                    <td class="px-3 py-2 text-sm text-green-600">${stats.paid} (${paymentRate}%)</td>
                    <td class="px-3 py-2 text-sm font-medium text-gray-900">${formatCurrency(stats.amount)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePaymentMethodAnalysis(filteredBills) {
            const container = document.getElementById('paymentMethodAnalysis');
            container.innerHTML = '';
            
            const methodStats = {
                transfer: { count: 0, amount: 0 },
                tunai: { count: 0, amount: 0 }
            };
            
            filteredBills.forEach(bill => {
                methodStats[bill.paymentMethod].count++;
                methodStats[bill.paymentMethod].amount += bill.amount;
            });
            
            const totalCount = filteredBills.length;
            const totalAmount = filteredBills.reduce((sum, bill) => sum + bill.amount, 0);
            
            Object.entries(methodStats).forEach(([method, stats]) => {
                const countPercentage = totalCount > 0 ? Math.round((stats.count / totalCount) * 100) : 0;
                const amountPercentage = totalAmount > 0 ? Math.round((stats.amount / totalAmount) * 100) : 0;
                
                const methodDiv = document.createElement('div');
                methodDiv.className = 'p-4 bg-gray-50 rounded-lg';
                methodDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-900">${method === 'transfer' ? '💳 Transfer' : '💵 Tunai'}</span>
                        <span class="text-sm text-gray-600">${stats.count} transaksi</span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Jumlah: ${countPercentage}%</span>
                            <span>Nilai: ${amountPercentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: ${countPercentage}%"></div>
                        </div>
                    </div>
                    <div class="text-lg font-semibold text-gray-900">${formatCurrency(stats.amount)}</div>
                `;
                container.appendChild(methodDiv);
            });
        }

        function updateMonthlyTrend(filteredBills) {
            const tbody = document.getElementById('monthlyTrendTable');
            tbody.innerHTML = '';
            
            // Group by month
            const monthlyStats = {};
            filteredBills.forEach(bill => {
                const monthKey = bill.date.substring(0, 7); // YYYY-MM
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        total: 0,
                        paid: 0,
                        pending: 0,
                        amount: 0
                    };
                }
                monthlyStats[monthKey].total++;
                if (bill.status === 'paid') {
                    monthlyStats[monthKey].paid++;
                } else {
                    monthlyStats[monthKey].pending++;
                }
                monthlyStats[monthKey].amount += bill.amount;
            });
            
            // Sort by month descending
            const sortedMonths = Object.entries(monthlyStats).sort((a, b) => b[0].localeCompare(a[0]));
            
            sortedMonths.forEach(([month, stats]) => {
                const paymentRate = stats.total > 0 ? Math.round((stats.paid / stats.total) * 100) : 0;
                const monthName = new Date(month + '-01').toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${monthName}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.total}</td>
                    <td class="px-4 py-2 text-sm text-green-600">${stats.paid}</td>
                    <td class="px-4 py-2 text-sm text-yellow-600">${stats.pending}</td>
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${formatCurrency(stats.amount)}</td>
                    <td class="px-4 py-2 text-sm">
                        <div class="flex items-center">
                            <span class="mr-2">${paymentRate}%</span>
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: ${paymentRate}%"></div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateUserActivity() {
            const tbody = document.getElementById('userActivityTable');
            tbody.innerHTML = '';
            
            // Calculate user activity stats
            const userStats = {};
            
            // Initialize all users
            Object.keys(userAccounts).forEach(username => {
                userStats[username] = {
                    created: 0,
                    edited: 0,
                    lastActive: null
                };
            });
            
            // Count activities
            bills.forEach(bill => {
                if (bill.createdBy && userStats[bill.createdBy] !== undefined) {
                    userStats[bill.createdBy].created++;
                    const createdDate = new Date(bill.createdAt);
                    if (!userStats[bill.createdBy].lastActive || createdDate > userStats[bill.createdBy].lastActive) {
                        userStats[bill.createdBy].lastActive = createdDate;
                    }
                }
                
                if (bill.updatedBy && bill.updatedBy !== bill.createdBy && userStats[bill.updatedBy] !== undefined) {
                    userStats[bill.updatedBy].edited++;
                    const updatedDate = new Date(bill.updatedAt);
                    if (!userStats[bill.updatedBy].lastActive || updatedDate > userStats[bill.updatedBy].lastActive) {
                        userStats[bill.updatedBy].lastActive = updatedDate;
                    }
                }
            });
            
            // Sort by total activity
            const sortedUsers = Object.entries(userStats).sort((a, b) => (b[1].created + b[1].edited) - (a[1].created + a[1].edited));
            
            sortedUsers.forEach(([username, stats]) => {
                const user = userAccounts[username];
                const totalActivity = stats.created + stats.edited;
                const lastActiveText = stats.lastActive ? stats.lastActive.toLocaleDateString('id-ID') : 'Belum ada aktivitas';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-900">${user.name}</span>
                            <span class="text-xs text-gray-500">@${username}</span>
                        </div>
                    </td>
                    <td class="px-4 py-2 text-sm text-gray-600">${stats.created}</td>
                    <td class="px-4 py-2 text-sm text-blue-600">${stats.edited}</td>
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${totalActivity}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${lastActiveText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showUserManagement() {
            if (!checkPermission('settings')) {
                showToast('Anda tidak memiliki izin untuk mengakses kelola user', 'error');
                return;
            }
            hideAllContent();
            setActiveMenu('menuUserManagement');
            document.getElementById('pageTitle').textContent = 'Kelola User';
            document.getElementById('userManagementContent').classList.remove('hidden');
            renderUserList();
        }

        function showSettings() {
            hideAllContent();
            setActiveMenu('menuSettings');
            document.getElementById('pageTitle').textContent = 'Pengaturan';
            document.getElementById('settingsContent').classList.remove('hidden');
        }

        function register(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (name && email && password) {
                // In real app, this would save to database
                showToast('Akun berhasil dibuat! Silakan login.', 'success');
                showLogin();
                // Clear form
                document.getElementById('registerForm').reset();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // Bill management functions
        function updateStats() {
            const totalBills = bills.length;
            const paidBills = bills.filter(bill => bill.status === 'paid').length;
            const pendingBills = bills.filter(bill => bill.status === 'pending').length;
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);

            document.getElementById('totalBills').textContent = totalBills;
            document.getElementById('paidBills').textContent = paidBills;
            document.getElementById('pendingBills').textContent = pendingBills;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function renderTable() {
            const tbody = document.getElementById('billsTableBody');
            const createdByHeader = document.getElementById('createdByHeader');
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // Show/hide creator column based on admin status
            if (isAdmin) {
                createdByHeader.style.display = 'table-cell';
            } else {
                createdByHeader.style.display = 'none';
            }
            
            tbody.innerHTML = '';

            bills.forEach(bill => {
                const row = document.createElement('tr');
                const canEdit = checkPermission('edit');
                const canDelete = checkPermission('delete');
                
                // Build action buttons based on permissions
                let actionButtons = '';
                if (canEdit) {
                    actionButtons += `<button onclick="editBill(${bill.id})" class="text-indigo-600 hover:text-indigo-900 mr-2 md:mr-3 p-1" title="Edit">
                        <i class="fas fa-edit text-sm"></i>
                    </button>`;
                }
                if (canDelete) {
                    actionButtons += `<button onclick="deleteBill(${bill.id})" class="text-red-600 hover:text-red-900 p-1" title="Hapus">
                        <i class="fas fa-trash text-sm"></i>
                    </button>`;
                }
                if (!canEdit && !canDelete) {
                    actionButtons = '<span class="text-gray-400 text-xs">Hanya Lihat</span>';
                }
                
                // Get creator info
                const creatorName = userAccounts[bill.createdBy] ? userAccounts[bill.createdBy].name : bill.createdBy;
                const createdDate = bill.createdAt ? new Date(bill.createdAt).toLocaleDateString('id-ID') : '-';
                const wasEdited = bill.updatedBy !== bill.createdBy;
                const editorName = wasEdited && userAccounts[bill.updatedBy] ? userAccounts[bill.updatedBy].name : '';
                
                // Creator column content
                const creatorColumn = isAdmin ? `
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900">
                        <div class="flex flex-col">
                            <span class="font-medium">${creatorName}</span>
                            <span class="text-xs text-gray-500">${createdDate}</span>
                            ${wasEdited ? `<span class="text-xs text-blue-600">✏️ ${editorName}</span>` : ''}
                        </div>
                    </td>
                ` : '';
                
                row.innerHTML = `
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900">${bill.invoiceNumber}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900">${bill.customerName}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900">${new Date(bill.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-900">${formatCurrency(bill.amount)}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${bill.paymentMethod === 'transfer' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                            ${bill.paymentMethod === 'transfer' ? 'Transfer' : 'Tunai'}
                        </span>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${bill.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${bill.status === 'paid' ? 'Lunas' : 'Belum Lunas'}
                        </span>
                    </td>
                    ${creatorColumn}
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm font-medium">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddForm() {
            // Check permission first
            if (!checkPermission('add')) {
                showToast('Anda tidak memiliki izin untuk menambah data', 'error');
                return;
            }
            
            editingId = null;
            document.getElementById('formTitle').textContent = 'Tambah Tagihan';
            document.getElementById('billForm').reset();
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billDate').value = today;
            
            document.getElementById('formModal').classList.remove('hidden');
            document.getElementById('formModal').classList.add('flex');
            
            console.log('Add form opened, editingId:', editingId); // Debug log
        }

        function editBill(id) {
            // Check permission first
            if (!checkPermission('edit')) {
                showToast('Anda tidak memiliki izin untuk mengedit data', 'error');
                return;
            }
            
            const bill = bills.find(b => b.id === id);
            if (bill) {
                editingId = id;
                document.getElementById('formTitle').textContent = 'Edit Tagihan';
                document.getElementById('invoiceNumber').value = bill.invoiceNumber;
                document.getElementById('customerName').value = bill.customerName;
                document.getElementById('billDate').value = bill.date;
                document.getElementById('amount').value = bill.amount;
                document.getElementById('paymentMethod').value = bill.paymentMethod || 'tunai';
                document.getElementById('status').value = bill.status;
                document.getElementById('formModal').classList.remove('hidden');
                document.getElementById('formModal').classList.add('flex');
            }
        }

        function deleteBill(id) {
            // Check permission first
            if (!checkPermission('delete')) {
                showToast('Anda tidak memiliki izin untuk menghapus data', 'error');
                return;
            }
            
            // Custom confirmation instead of browser confirm()
            const billToDelete = bills.find(b => b.id === id);
            if (billToDelete) {
                showCustomConfirm(
                    `Hapus tagihan petugas ${billToDelete.invoiceNumber} untuk pelanggan ${billToDelete.customerName}?`,
                    () => {
                        const originalLength = bills.length;
                        bills = bills.filter(b => b.id !== id);
                        
                        if (bills.length < originalLength) {
                            // Save to localStorage
                            saveBillsToStorage();
                            
                            updateStats();
                            renderTable();
                            updateRecentActivity();
                            showToast('Tagihan berhasil dihapus', 'success');
                        } else {
                            showToast('Gagal menghapus tagihan', 'error');
                        }
                    }
                );
            }
        }

        function closeModal() {
            document.getElementById('formModal').classList.add('hidden');
            document.getElementById('formModal').classList.remove('flex');
        }

        function saveBill(event) {
            event.preventDefault();
            
            // Validate form data
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const billDate = document.getElementById('billDate').value;
            const amount = document.getElementById('amount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const status = document.getElementById('status').value;
            
            // Basic validation
            if (!invoiceNumber || !customerName || !billDate || !amount) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }
            
            if (parseInt(amount) <= 0) {
                showToast('Jumlah harus lebih dari 0!', 'error');
                return;
            }
            
            const formData = {
                invoiceNumber: invoiceNumber,
                customerName: customerName,
                date: billDate,
                amount: parseInt(amount),
                paymentMethod: paymentMethod,
                status: status
            };

            if (editingId) {
                // Update existing bill
                const index = bills.findIndex(b => b.id === editingId);
                if (index !== -1) {
                    bills[index] = { 
                        ...bills[index], 
                        ...formData,
                        updatedBy: currentUser.username,
                        updatedAt: new Date().toISOString()
                    };
                    showToast('Tagihan berhasil diperbarui', 'success');
                    console.log('Updated bill:', bills[index]); // Debug log
                } else {
                    showToast('Data tidak ditemukan untuk diupdate', 'error');
                    return;
                }
            } else {
                // Add new bill
                const newBill = {
                    id: Date.now() + Math.random(), // Ensure unique ID
                    ...formData,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString(),
                    updatedBy: currentUser.username,
                    updatedAt: new Date().toISOString()
                };
                bills.push(newBill);
                showToast('Tagihan berhasil ditambahkan', 'success');
                console.log('Added new bill:', newBill); // Debug log
            }

            // Save to localStorage
            saveBillsToStorage();

            // Reset editing state
            editingId = null;
            
            // Update UI
            updateStats();
            renderTable();
            updateRecentActivity();
            closeModal();
        }

        // Export functions
        function exportPDF() {
            if (!checkPermission('export')) {
                showToast('Anda tidak memiliki izin untuk export data', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Use landscape orientation for better table layout

            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('LAPORAN REKAP PENAGIHAN DIGITAL', 20, 20);
            
            // Summary info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const paidBills = bills.filter(bill => bill.status === 'paid').length;
            const pendingBills = bills.filter(bill => bill.status === 'pending').length;
            
            doc.text(`Tanggal Export: ${new Date().toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`, 20, 35);
            doc.text(`Diekspor oleh: ${currentUser.name}`, 20, 42);
            doc.text(`Total Tagihan: ${bills.length} | Lunas: ${paidBills} | Belum Lunas: ${pendingBills} | Total Nilai: ${formatCurrency(totalAmount)}`, 20, 49);

            // Table setup
            const startY = 60;
            const rowHeight = 8;
            const pageHeight = doc.internal.pageSize.height;
            const marginBottom = 20;
            
            // Column positions and widths (landscape: ~297mm width)
            const columns = [
                { header: 'No', x: 20, width: 12 },
                { header: 'Nama Petugas', x: 32, width: 35 },
                { header: 'Nama Pelanggan', x: 67, width: 50 },
                { header: 'Tanggal', x: 117, width: 25 },
                { header: 'Jumlah (Rp)', x: 142, width: 35 },
                { header: 'Metode', x: 177, width: 25 },
                { header: 'Status', x: 202, width: 25 }
            ];

            let currentY = startY;
            let pageNumber = 1;

            // Function to draw table header
            function drawTableHeader() {
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                // Draw header background
                doc.setFillColor(240, 240, 240);
                doc.rect(20, currentY - 2, 215, rowHeight, 'F');
                
                // Draw header borders
                doc.setDrawColor(0, 0, 0);
                doc.rect(20, currentY - 2, 215, rowHeight);
                
                // Draw column separators
                columns.forEach((col, index) => {
                    if (index > 0) {
                        doc.line(col.x, currentY - 2, col.x, currentY + rowHeight - 2);
                    }
                });
                
                // Header text
                columns.forEach(col => {
                    doc.text(col.header, col.x + 2, currentY + 3);
                });
                
                currentY += rowHeight;
            }

            // Function to add new page
            function addNewPage() {
                doc.addPage('landscape');
                pageNumber++;
                currentY = 30;
                
                // Add page number
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text(`Halaman ${pageNumber}`, 250, 15);
                
                drawTableHeader();
            }

            // Function to check if we need a new page
            function checkNewPage() {
                if (currentY + rowHeight > pageHeight - marginBottom) {
                    addNewPage();
                }
            }

            // Draw initial header
            doc.setFontSize(8);
            doc.text(`Halaman ${pageNumber}`, 250, 15);
            drawTableHeader();

            // Draw table rows
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            
            bills.forEach((bill, index) => {
                checkNewPage();
                
                // Draw row background (alternating colors)
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(20, currentY - 1, 215, rowHeight, 'F');
                }
                
                // Draw row borders
                doc.setDrawColor(200, 200, 200);
                doc.rect(20, currentY - 1, 215, rowHeight);
                
                // Draw column separators
                columns.forEach((col, colIndex) => {
                    if (colIndex > 0) {
                        doc.line(col.x, currentY - 1, col.x, currentY + rowHeight - 1);
                    }
                });
                
                // Row data
                const rowData = [
                    (index + 1).toString(),
                    bill.invoiceNumber,
                    bill.customerName.length > 20 ? bill.customerName.substring(0, 20) + '...' : bill.customerName,
                    new Date(bill.date).toLocaleDateString('id-ID'),
                    formatCurrency(bill.amount).replace('Rp', '').trim(),
                    bill.paymentMethod === 'transfer' ? 'Transfer' : 'Tunai',
                    bill.status === 'paid' ? 'Lunas' : 'Belum Lunas'
                ];
                
                // Draw text in each column
                columns.forEach((col, colIndex) => {
                    const text = rowData[colIndex];
                    const textX = col.x + 2;
                    const textY = currentY + 4;
                    
                    // Right align for amount column
                    if (colIndex === 4) {
                        const textWidth = doc.getTextWidth(text);
                        doc.text(text, col.x + col.width - textWidth - 2, textY);
                    } else {
                        doc.text(text, textX, textY);
                    }
                });
                
                currentY += rowHeight;
            });

            // Footer with summary
            currentY += 10;
            checkNewPage();
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('RINGKASAN:', 20, currentY);
            currentY += 8;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Total Tagihan: ${bills.length}`, 20, currentY);
            doc.text(`Tagihan Lunas: ${paidBills}`, 80, currentY);
            doc.text(`Belum Lunas: ${pendingBills}`, 140, currentY);
            currentY += 6;
            doc.text(`Total Nilai Keseluruhan: ${formatCurrency(totalAmount)}`, 20, currentY);
            
            // Footer
            currentY += 15;
            doc.setFontSize(8);
            doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')} oleh ${currentUser.name}`, 20, currentY);

            // Save the PDF
            const fileName = `rekap-penagihan-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            showToast('PDF berhasil diunduh dengan format tabel lengkap!', 'success');
        }

        function exportExcel() {
            if (!checkPermission('export')) {
                showToast('Anda tidak memiliki izin untuk export data', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(bills.map(bill => ({
                'Nama Petugas': bill.invoiceNumber,
                'Pelanggan': bill.customerName,
                'Tanggal': bill.date,
                'Jumlah': bill.amount,
                'Metode Pembayaran': bill.paymentMethod === 'transfer' ? 'Transfer' : 'Tunai',
                'Status': bill.status === 'paid' ? 'Lunas' : 'Belum Lunas'
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Penagihan');
            XLSX.writeFile(wb, 'rekap-penagihan.xlsx');
            showToast('Excel berhasil diunduh', 'success');
        }

        function exportJSON() {
            // Create export data with metadata
            const exportData = {
                metadata: {
                    exportedBy: currentUser.name,
                    exportedAt: new Date().toISOString(),
                    totalRecords: bills.length,
                    systemVersion: '1.0'
                },
                bills: bills
            };

            // Create and download JSON file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `rekap-penagihan-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('File JSON berhasil diunduh! Siap untuk dibagikan.', 'success');
        }

        function shareViaWhatsApp() {
            // Show sharing options modal
            showWhatsAppShareModal();
        }

        function showWhatsAppShareModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fab fa-whatsapp text-4xl text-green-500 mb-3"></i>
                        <h3 class="text-xl font-bold text-gray-900">Kirim Data via WhatsApp</h3>
                        <p class="text-gray-600 mt-2">Pilih cara mengirim data JSON</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="shareWithAutoFile()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200 flex items-center justify-center">
                            <i class="fas fa-magic mr-2"></i>
                            Otomatis Kirim File + Pesan
                        </button>
                        
                        <button onclick="shareManualDownload()" class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i>
                            Download Manual + Pesan
                        </button>
                        
                        <button onclick="shareOnlyMessage()" class="w-full bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-200 flex items-center justify-center">
                            <i class="fas fa-comment mr-2"></i>
                            Hanya Kirim Ringkasan
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">
                        Batal
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function shareWithAutoFile() {
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Create export data
            const exportData = {
                metadata: {
                    exportedBy: currentUser.name,
                    exportedAt: new Date().toISOString(),
                    totalRecords: bills.length,
                    systemVersion: '1.0'
                },
                bills: bills
            };

            // Create summary message
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const paidCount = bills.filter(bill => bill.status === 'paid').length;
            const pendingCount = bills.filter(bill => bill.status === 'pending').length;
            
            const message = `📊 *REKAP PENAGIHAN DIGITAL*
            
👤 Dikirim oleh: ${currentUser.name}
📅 Tanggal: ${new Date().toLocaleDateString('id-ID')}
📋 Total Tagihan: ${bills.length}
✅ Lunas: ${paidCount}
⏳ Belum Lunas: ${pendingCount}
💰 Total Nilai: ${formatCurrency(totalAmount)}

📎 File JSON otomatis tersedia untuk di-import ke sistem admin.

*Cara Import:*
1. Login sebagai admin
2. Klik "Import JSON" 
3. Pilih file yang dikirim
4. Data akan masuk otomatis

#SistemPenagihanDigital #DataExport`;

            // Create file content as text for sharing
            const fileContent = JSON.stringify(exportData, null, 2);
            const fileName = `rekap-penagihan-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
            
            // Try to use Web Share API if available (works on mobile)
            if (navigator.share && navigator.canShare) {
                // Create a blob and file for sharing
                const blob = new Blob([fileContent], { type: 'application/json' });
                const file = new File([blob], fileName, { type: 'application/json' });
                
                if (navigator.canShare({ files: [file] })) {
                    navigator.share({
                        title: 'Rekap Penagihan Digital',
                        text: message,
                        files: [file]
                    }).then(() => {
                        showToast('File berhasil dibagikan!', 'success');
                    }).catch((error) => {
                        console.log('Share failed:', error);
                        // Fallback to manual download + WhatsApp
                        shareManualDownload();
                    });
                    return;
                }
            }
            
            // Fallback: Download file + open WhatsApp
            shareManualDownload();
        }

        function shareManualDownload() {
            // Close modal if exists
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
            
            // Create export data
            const exportData = {
                metadata: {
                    exportedBy: currentUser.name,
                    exportedAt: new Date().toISOString(),
                    totalRecords: bills.length,
                    systemVersion: '1.0'
                },
                bills: bills
            };

            // Create summary message
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const paidCount = bills.filter(bill => bill.status === 'paid').length;
            const pendingCount = bills.filter(bill => bill.status === 'pending').length;
            
            const message = `📊 *REKAP PENAGIHAN DIGITAL*
            
👤 Dikirim oleh: ${currentUser.name}
📅 Tanggal: ${new Date().toLocaleDateString('id-ID')}
📋 Total Tagihan: ${bills.length}
✅ Lunas: ${paidCount}
⏳ Belum Lunas: ${pendingCount}
💰 Total Nilai: ${formatCurrency(totalAmount)}

📎 File JSON telah diunduh otomatis untuk di-import ke sistem admin.

*Cara Import:*
1. Login sebagai admin
2. Klik "Import JSON"
3. Pilih file JSON yang diunduh
4. Data akan masuk otomatis

Silakan kirim file JSON bersama pesan ini.

#SistemPenagihanDigital #DataExport`;

            // Download JSON file first
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `rekap-penagihan-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Open WhatsApp with message
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            // Open in new tab
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            showToast('File JSON diunduh & WhatsApp terbuka! Kirim file bersama pesan.', 'success');
        }

        function shareOnlyMessage() {
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Create summary message only
            const totalAmount = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const paidCount = bills.filter(bill => bill.status === 'paid').length;
            const pendingCount = bills.filter(bill => bill.status === 'pending').length;
            
            const message = `📊 *RINGKASAN PENAGIHAN DIGITAL*
            
👤 Dari: ${currentUser.name}
📅 Tanggal: ${new Date().toLocaleDateString('id-ID')}
📋 Total Tagihan: ${bills.length}
✅ Lunas: ${paidCount}
⏳ Belum Lunas: ${pendingCount}
💰 Total Nilai: ${formatCurrency(totalAmount)}

📝 *Detail Tagihan:*
${bills.map((bill, index) => 
`${index + 1}. ${bill.customerName} - ${formatCurrency(bill.amount)} - ${bill.paymentMethod === 'transfer' ? '💳 Transfer' : '💵 Tunai'} (${bill.status === 'paid' ? '✅ Lunas' : '⏳ Belum Lunas'})`
).join('\n')}

#SistemPenagihanDigital #Ringkasan`;

            // Open WhatsApp with message
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            // Open in new tab
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            showToast('WhatsApp terbuka dengan ringkasan data!', 'info');
        }

        function importJSON(event) {
            if (!checkPermission('import')) {
                showToast('Anda tidak memiliki izin untuk import data', 'error');
                event.target.value = ''; // Reset file input
                return;
            }
            
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let billsToImport = [];
                        let importInfo = '';
                        
                        // Check if it's the new format with metadata
                        if (importedData.metadata && importedData.bills) {
                            billsToImport = importedData.bills;
                            importInfo = `Data dari ${importedData.metadata.exportedBy} (${new Date(importedData.metadata.exportedAt).toLocaleDateString('id-ID')})`;
                        } else if (Array.isArray(importedData)) {
                            // Old format - direct array
                            billsToImport = importedData;
                            importInfo = 'Data format lama';
                        } else {
                            showToast('Format JSON tidak valid', 'error');
                            return;
                        }
                        
                        // Add imported data to existing bills
                        billsToImport.forEach(item => {
                            const newBill = {
                                id: Date.now() + Math.random(),
                                invoiceNumber: item.invoiceNumber || `INV-${Date.now()}`,
                                customerName: item.customerName || 'Unknown',
                                date: item.date || new Date().toISOString().split('T')[0],
                                amount: parseInt(item.amount) || 0,
                                paymentMethod: item.paymentMethod || 'tunai',
                                status: item.status || 'pending',
                                createdBy: item.createdBy || currentUser.username,
                                createdAt: item.createdAt || new Date().toISOString(),
                                updatedBy: item.updatedBy || currentUser.username,
                                updatedAt: item.updatedAt || new Date().toISOString()
                            };
                            bills.push(newBill);
                        });
                        
                        // Save to localStorage
                        saveBillsToStorage();
                        
                        updateStats();
                        renderTable();
                        updateRecentActivity();
                        showToast(`${billsToImport.length} data berhasil diimpor dari ${importInfo}`, 'success');
                        
                    } catch (error) {
                        showToast('Error membaca file JSON', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Konfirmasi</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button id="confirmYes" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">
                            Ya, Hapus
                        </button>
                        <button id="confirmNo" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners
            const yesBtn = modal.querySelector('#confirmYes');
            const noBtn = modal.querySelector('#confirmNo');
            
            yesBtn.addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            noBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', login);
        document.getElementById('registerForm').addEventListener('submit', register);
        document.getElementById('billForm').addEventListener('submit', saveBill);
        document.getElementById('addUserForm').addEventListener('submit', addUser);

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // Initialize mobile menu
        function initializeMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const overlay = document.getElementById('mobileOverlay');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            }
            
            if (overlay) {
                overlay.addEventListener('click', closeMobileMenu);
            }
            
            // Close menu when clicking menu items on mobile
            const menuItems = document.querySelectorAll('#sidebar a');
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });
        }

        // Initialize
        updateStats();
        renderTable();
        updateRecentActivity();
        
        // Start time monitoring when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startTimeMonitoring();
            initializeMobileMenu();
            loadRememberedCredentials();
        });
        
        // Start immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                startTimeMonitoring();
                initializeMobileMenu();
                loadRememberedCredentials();
            });
        } else {
            startTimeMonitoring();
            initializeMobileMenu();
            loadRememberedCredentials();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994aab7a20683fd0',t:'MTc2MTQ4OTIxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
